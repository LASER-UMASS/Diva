############################################################################
#
#  Primary targets:
#    all           - the default target; synonym for 'coq'
#    coq           - builds all .vo files
#    doc           - synonym for 'documentation'
#    install       - copy to coq library location
#    clean         - removes generated files
#
#  Other targets (intended to be used by the developers of this library):
#    gens          - builds generated .v files on demand
#    dist          - builds a zip file for distribution
#
############################################################################

## Paths to executables. Do not include options here.
## Modify these to suit your Coq installation, if necessary.

## If you get warnings such as:
## *** Warning: in file AssocList.v, library CoqFSetDecide is required and has not been found in the loadpath!
## you can use a shell variable to set the load path. (Somehow the -I below is being ignored.)
## export COQPATH=.

COQC = coqc
COQDEP = coqdep
COQDOC = coqdoc


## Library name used for the imports in Coq

LIBNAME=Metalib

## Name of the submakefile generated by coq_makefile

COQMKFILENAME=CoqSrc.mk


############################################################################

.PHONY: all clean coq dist doc gens
.SUFFIXES: .v .vo .v.d .v.glob

all: coq

%.mk : Makefile _%
	coq_makefile -f _$* -o $*.mk

$(COQMKFILENAME): Makefile
	{ echo "-R . $(LIBNAME) " ; ls *.v ; } > _CoqProject && coq_makefile -f _CoqProject -o $(COQMKFILENAME)

coq: $(COQMKFILENAME)
	@$(MAKE) -f $(COQMKFILENAME)

doc:
	@$(MAKE) -f $(COQMKFILENAME) html

install: all
	@$(MAKE) -f $(COQMKFILENAME) install

clean:
	@$(MAKE) -f $(COQMKFILENAME) clean
	rm -if $(COQMKFILENAME)


############################################################################

DATE = $(shell date +%Y%m%d)
DIR  = metalib-$(DATE)

COQSPLIT = ../../books/sf/tools/coqsplit
STLC = ../../books/coqbook/stlc/STLC.v

gens:
	make -C ../../books/sf tools/coqsplit
	$(COQSPLIT) < $(STLC) > STLC.v
	$(COQSPLIT) -solutions < $(STLC) > STLCsol.v

dist:
	svn export . $(DIR)
	(cd $(DIR); $(MAKE) documentation)
	rm -f $(DIR)/*.vo $(DIR)/*.glob
	rm -f $(DIR)/TODO.txt
	echo Release $(DATE) / svn revision `svnversion .` >> $(DIR)/VERSION
	zip -r $(DIR).zip $(DIR)
	@echo
	@echo Done.
	@echo See $(DIR) and $(DIR).zip.
